<!DOCTYPE html>
<!--HTML5 doctype-->
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
		<title>确认订单 </title>
		<meta name="keywords" content="{site.seo_keyword}" />
		<meta name="description" content="{site.seo_description}" />
		<link rel="stylesheet" type="text/css" href="../css/validate.css" />
		<link rel="stylesheet" type="text/css" href="../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../css/index.min_e69bc1e2.css" />
		<link rel="stylesheet" type="text/css" href="../css/jquery-weui.css" />
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<script type="text/javascript" charset="utf-8" src="../scripts/jquery/PCASClass.js"></script>
		<script type="text/javascript" charset="utf-8" src="../js/zepto.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="../js/mui.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="../js/mvalidate.js"></script>
		<script type="text/javascript" charset="utf-8" src="../js/mvalidate-extend.js"></script>
		<script type="text/javascript" charset="utf-8" src="../js/common.js"></script>
		<script type="text/javascript" charset="utf-8" src="../js/product_cart.js"></script>
		<script src="../js/pay/common.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.plusReady(function() {
				localStorage.setItem('is_order_pay', 0)
				localStorage.setItem('is_pin', 0)
			});
		</script>
	</head>

	<body ontouchstart>
		<div class="page">
			<!--页面头部-->
			<div class="header" style="display: none;">
				<a class="back" href="javascript:history.back();">
					<i class="iconfont icon-arrow-left"></i>
				</a>
				<h3 style="margin-top: 0;">订单确认</h3>
				<div class="right">
					<a class="weui-cell_access weui-cell_link" href="index.html">
						<i class="iconfont icon-home"></i>
					</a>
				</div>
			</div>
			<!--/页面头部-->

			<!--页面内容-->
			<div class="page__bd" style="position: relative;">

				<!--地址簿-->
				<div class="weui-panel weui-panel_access" style="margin-top:10px;display: none;">
					<div class="weui-panel__hd">我的地址簿</div>
					<div class="weui-panel__bd">
						<div id="userAddress" class="weui-cells_radio form-box ">
							<ul class="mui-table-view mui-table-view-radio address_list"></ul>
						</div>

					</div>
				</div>
				<!--/地址簿-->

				<form id="orderForm" name="orderForm">
					<input id="pay_type" name="pay_type" type="hidden" />
					<input id="is_pin" name="is_pin" type="hidden" />
					<input id="pin_order_id" name="pin_order_id" type="hidden" />
					<input id="pid" name="pid" type="hidden" value="0" />
					<input id="jsondata" name="jsondata" type="hidden" />
					<input id="is_mobile" name="is_mobile" type="hidden" value="1" />
					<input id="user_id" name="user_id" type="hidden" value="1" />
					<input id="hot_id" name="hot_id" type="hidden" />
					<input id="goods_order_type" name="goods_order_type" type="hidden" />
					<input id="payment_id" name="payment_id" class="weui-switch" type="hidden" value="0" />
					<div id="addressNull" class="address_null" style="display: none;">
						<h3>！请填写收货地址</h3>
					</div>
					<div class="address_defalut_wrap" id="topFixedDiv">
						<div id="addressDefault" class="address_defalut address_border" style="display: block;">

						</div>
					</div>
					<!--收货地址-->
					<div class="weui-panel weui-panel_access" style="margin-top:0px;">
						<div class="weui-panel__hd" style="display:none">收货地址</div>
						<div class="weui-panel__bd">
							<div class="weui-cells_form form-box" style="display:none">
								<input name="book_id" id="book_id" type="hidden" value="0" />
								<div class="weui-cell">
									<div class="weui-cell__hd">
										<label class="weui-label">收货姓名</label>
									</div>
									<div class="weui-cell__bd">
										<input id="accept_name" name="accept_name" class="weui-input" type="text" placeholder="收件人名称" />
									</div>
								</div>

								<div class="weui-cell">
									<div class="weui-cell__hd">
										<label class="weui-label">所属地区</label>
									</div>
									<div class="weui-cell__bd">
										<script type="text/javascript" charset="utf-8" src="../js/jquery-weui.js"></script>
										<script type="text/javascript" charset="utf-8" src="../js/city-picker.js"></script>

										<input class="weui-input" name="txtArea" id="city-picker" type="text" readonly="">
										<input id="area" name="area" type="hidden" />
										<script>
											//											$("#city-picker").cityPicker({
											//												title: "选择地区",
											//												onChange: function(picker, values, displayValues) {
											//													$('#area').val(displayValues[0] + ' ' + displayValues[1] + ' ' + displayValues[2]);
											//													//$('#area').val(displayValues[0] + ' ' + displayValues[1] + ' ' + displayValues[2]);
											//												}
											//											});
										</script>

									</div>
								</div>

								<div class="weui-cell">
									<div class="weui-cell__hd">
										<label class="weui-label">详细地址</label>
									</div>
									<div class="weui-cell__bd">
										<input id="address" name="address" class="weui-input" type="text" placeholder="详细地址" />
									</div>
								</div>

								<div class="weui-cell">
									<div class="weui-cell__hd">
										<label class="weui-label">手机号码</label>
									</div>
									<div class="weui-cell__bd">
										<input id="mobile" name="mobile" class="weui-input" type="tel" placeholder="请输入手机号" />
									</div>
								</div>

							</div>

						</div>
					</div>
					<!--/收货地址-->

					<!--配送方式-->
					<!--<div class="weui-panel weui-panel_access">
            <div class="weui-panel__hd">配送方式</div>
            <div class="weui-panel__bd">
                <div class="weui-cells_radio form-box">
                    <%set DataTable expressList=get_express_list(0, "")%>
                    <%foreach(DataRow dr in expressList.Rows)%>
                    <label class="weui-cell weui-check__label" for="e-{dr[id]}">
                        <div class="weui-cell__bd">
                            <p>{dr[title]}<i>运费 {dr[express_fee]} 元</i></p>
                        </div>
                        <div class="weui-cell__ft">
                            <input id="e-{dr[id]}" name="express_id" type="radio" class="weui-check" onclick="freightAmountTotal(this);" price="{dr[express_fee]}" value="{dr[id]}" data-validate="select" />
                            <span class="weui-icon-checked"></span>
                        </div>
                    </label>
                    <%/foreach%>
                </div>
                
            </div>
        </div>-->
					<!--/配送方式-->

					<!--商品清单-->
					<div class="weui-panel weui-panel_access">
						<div class="weui-panel__hd">商品列表</div>
						<div class="weui-panel__bd">
							<div class="cart-list  inset">
								<ul class="goods_list">

								</ul>
							</div>

						</div>
					</div>
					<!--/商品清单-->
					<!--支付方式-->
					<div class="weui-panel weui-panel_access payment_div">
						<div class="weui-panel__hd">支付方式</div>
						<div class="weui-panel__bd ">
							<ul class="mui-table-view mui-table-view-radio payment_list"></ul>

						</div>
					</div>
					<!--/支付方式-->
					<!--结算信息-->
					<div class="weui-panel weui-panel_access">
						<div class="weui-panel__hd" style="display: none;">结算信息</div>
						<div class="weui-panel__bd">
							<div class="weui-cells_form form-box">
								<div class="weui-cell weui-cell_switch payment_id" style="display: none;">
									<div class="weui-cell__bd">是否赠送</div>
									<div class="weui-cell__ft">
										<input id="is_give" name="is_give" class="weui-switch" type="hidden" value="0" />
										<input id="is_give1" name="is_give1" class="weui-switch" type="checkbox" />
									</div>
								</div>
								<!--<div class="weui-cell weui-cell_switch payment_id">
									<div class="weui-cell__bd">是否到付</div>
									<div class="weui-cell__ft">
										<input id="payment_id" name="payment_id" class="weui-switch" type="hidden" value="0" />
										<input id="payment_id1" name="payment_id1" class="weui-switch" type="checkbox" />
									</div>
								</div>-->
								<!--<div id="invoiceBox" class="weui-cell" style="display:none;">
									<div class="weui-cell__hd">
										<label class="weui-label">发票抬头</label>
									</div>
									<div class="weui-cell__bd">
										<input id="invoice_title" name="invoice_title" class="weui-input" type="text" placeholder="开具发票的抬头" />
									</div>
								</div>-->

								<div class="weui-cell" style="display: none;">
									<div class="weui-cell__bd">
										<textarea name="message" class="weui-textarea" placeholder="订单备注(100字以内)" rows="3"></textarea>
									</div>
								</div>

							</div>

							<div class="weui-form-preview form-preview">
								<div class="weui-form-preview__hd" style="display: none;">
									<label class="weui-form-preview__label">应付价格</label>
									<em class="weui-form-preview__value"> <label id="totalAmount" ></label>元</em>
								</div>
								<div class="weui-form-preview__bd" style="display: none;">
									<!--<div class="weui-form-preview__item">
										<label class="weui-form-preview__label">商品金额</label>
										<span class="weui-form-preview__value">¥<label id="goodsAmount">{goodsTotal.real_amount}</label>元</span>
									</div>
									<div class="weui-form-preview__item">
										<label class="weui-form-preview__label">税费</label>
										<span class="weui-form-preview__value">¥<label id="taxesFee">0.00</label>元</span>
									</div>-->
									<!--<div class="weui-form-preview__item">
										<label class="weui-form-preview__label">运费</label>
										<span class="weui-form-preview__value">¥<label id="expressFee">0.00</label>元</span>
									</div>
									<div class="weui-form-preview__item">
										<label class="weui-form-preview__label">支付手续费</label>
										<span class="weui-form-preview__value">¥<label id="paymentFee">0.00</label>元</span>
									</div>
									<div class="weui-form-preview__item">
										<label class="weui-form-preview__label">总拍币</label>
										<span class="weui-form-preview__value">{goodsTotal.total_point}分</span>
									</div>-->
								</div>
								<div id="payBtnList" style="display: none;">

								</div>
								<div class="weui-form-preview__ft" style="position: fixed;bottom: 0;height:40px;width: 100%;background: white;display: -webkit-box;">
									<a style="color: #4c2664; font-size: 20px;width: 70%;text-align: left;margin-left: 20px; font-weight: bold;" class="weui-form-preview__btn weui-form-preview__btn_default" href="javascript:void(0);" id="totalAmount1"></a>

									<button style="width: 30%;height:40px;line-height: 30px; color: white; background: #4c2664; " id="btnSubmit" type="button" class="weui-form-preview__btn weui-form-preview__btn_primary">确认支付</button>

								</div>
							</div>

						</div>
					</div>
				</form>
				<!--/结算信息-->

				<!--版权信息-->
				<!--/版权信息-->

				<!--底部导航-->

				<!--/底部导航-->

			</div>
			<!--/页面内容-->

		</div>
	</body>
	<div class="mod_alert show fixed " style="display: none;"><i class="icon"></i>
		<p>您还没有可用配送地址，是否新建一个配送地址？</p>
		<p class="btns">
			<a href="javascript:;" id="ui_btn_cancel" class="btn ">取消</a>
			<a href="javascript:;" id="ui_btn_confirm" class="btn btn_1">新建</a>
		</p>
	</div>
	<div class="mod_alert_mask show" style="display: none;"></div>

	<script type="text/javascript">
		init()

		function init() {
			mui.init({
				pullRefresh: {
					container: '.page__bd',
					down: {
						style: 'circle',
						color: localStorage.getItem('color'),
						auto: true,
						callback: down
					}
				}
			});

		}

		function down() {
			localStorage.setItem('is_shopping', 0)
			localStorage.setItem('hot_id', 0)
			get_user_addr_book_list_items();

			var user = localStorage.getItem('user');

			user = JSON.parse(user);
			localStorage.setItem('goods_order_type', 1)
			$('#user_id').val(user.id);
			$('#pin_order_id').val(localStorage.getItem('pin_order_id'));
			$('#hot_id').val(localStorage.getItem('hot_id'));
			$('#is_pin').val(localStorage.getItem('is_pin'));
			$('#pid').val(localStorage.getItem('pid'));
			$('#goods_order_type').val(localStorage.getItem('goods_order_type'));
			$('.page').css('padding-bottom', 100);

			get_cart_items(1);
			//初始化收货地址
			initUserAddress("#userAddress");
			//初始化表单
			//			AjaxInitForm('#orderForm', '#btnSubmit', 1);
			$('#payment_id1').change(function() {
				if($(this).is(':checked')) {
					$('#payment_id').val(1)
				} else {

					$('#payment_id').val(0)
				}
				if($('#is_give1').is(':checked')) {
					$('#is_give1').prop("checked", false);
					$('#is_give').val(0)
				}
			})
			$('#is_give1').change(function() {
				if($(this).is(':checked')) {
					$('#is_give').val(1)
				} else {

					$('#is_give').val(0)
				}
				if($('#payment_id1').is(':checked')) {
					$('#payment_id1').prop("checked", false);
					$('#payment_id').val(0)
				}
			})
			$('.pod').click(function() {

				$('#tipDiv').css('display', 'block');
				$('.mod_alert_mask').css('display', 'block');
				$('#codFloat .mod_alert ').css('display', 'block');
				$('#codFloat .mod_alert ').css('display', 'block');
			})
			//货到付款弹框  取消按钮
			$('#codGoPayCancel').click(function() {

				$('#tipDiv').css('display', 'none');
				$('.mod_alert_mask').css('display', 'none');
				$('#codFloat .mod_alert ').css('display', 'none');
				$('#codFloat .mod_alert ').css('display', 'none');
			})
			//货到付款弹框  提交按钮
			$('#codGoPay').click(function() {
				$('#payment_id').val(1)
				$('#btnSubmit').trigger("click");

			})
			//立即支付弹框  提交按钮
			$('#btnPayOnLine').click(function() {
				$('#payment_id').val(6)
				//				$('#btnSubmit').trigger("click");

			})
			var hot_id = localStorage.getItem('hot_id')
			if(hot_id == 0) {

				$('.payment_id').css('display', 'none');
			}
			$("#btnSubmit").click(function(e) {
				$("#btnSubmit").attr('disabled', true)
				order_save()

			})
			mui('.page__bd').pullRefresh().endPulldown();
		}
		window.addEventListener('back_shopping', function(e) {
			mui.back();
		});
		window.addEventListener('update_user_addr_book_list', function(e) {
			var set_address = localStorage.getItem('set_address');
			console.log(set_address)
			if(set_address == 1) {
				mui('.page__bd').pullRefresh().pulldownLoading();
				console.log(2222)
			}
		});
		mui.init({
			beforeback: function() {　　
				var list = plus.webview.currentWebview().opener();　　

				mui.fire(list, 'order_succeed');

			}
		});

		function order_save() {
			$("#btnSubmit").prop('disabled', true)
			console.log($('#orderForm').attr('url'));
			$.ajax({
				url: $('#orderForm').attr('url'),
				data: $('#orderForm').serialize(),
				dataType: 'json', //服务器返回json格式数据
				type: 'post', //HTTP请求类型
				timeout: 10000, //超时时间设置为10秒；

				success: function(data) {
					console.log(data)

					var status = data.status;
					if(status == 1) {
						
						mui.toast(data.info)
						//						openWindowWithTitle('支付成功', 'succeed.html')
						mui.back();
					} else {
						$("#btnSubmit").prop('disabled', false)
						mui.toast(data.info)
					}
					//lang()

				},
				error: function(xhr, type, errorThrown) {
					//异常处理；
					console.log(type);
				}
			});

		}
	</script>

</html>